<script src="https://d3js.org/d3.v4.min.js"></script>

<link href="https://fonts.googleapis.com/css?family=Aldrich|Arima+Madurai|Arvo|Henny+Penny|Indie+Flower|Libre+Baskerville|Pirata+One|Poiret+One|Sancreek|Satisfy|Share+Tech+Mono|Smokum|Snowburst+One|Special+Elite" rel="stylesheet">

<style>
    body {
      margin: 0;
    }
    div.tooltip-donut {
       position: absolute;
       text-align: center;
       padding: .5rem;
       background: #FFFFFF;
       color: #313639;
       border: 1px solid #313639;
       border-radius: 8px;
       pointer-events: none;
       font-size: 1.3rem;
  }
  </style>

<body>

</body>

<script>
    console.log(d3);

var margin = {top: 30, right: 20, bottom: 50, left: 50},
        width = 1000 - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;

// Ranges for axis (pixels)


// SVG graph will be made on
var svg = d3.select("body")
    .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", 
                "translate(" + margin.left + "," + margin.top + ")");

d3.csv("first_ascent.csv", function(error, data) {
    data.forEach(function(d) {
        d.Year = +d.Year;
    });

    var x = d3.scaleTime().range([0, width]).domain(d3.extent(data, function(d) { return new Date( getYear(d.Year))}));
    var y = d3.scaleLinear().range([height, 0]).domain(d3.extent(data, function(d) { return scaledGradeToNum(d.GradeYDS)}));

    // Scale the range of the data
    //y.domain(d3.extent(data, function(d) { return gradeToNum(d.GradeYDS); }));
    //Div that appears when mousing over point
    var div = d3.select("body").append("div")
        .attr("class", "tooltip-donut")
        .style("opacity", 0);

    // Add the scatterplot
    svg.selectAll("dot")
        .data(data)
        .enter().append("circle")
        .attr("fill", function(d) { return getColor(d.Sex) })
        .attr("r", function(d) { return 7 })
        .attr("cx", function(d) { return x(d.Year); })
        .attr("cy", function(d) { return y(gradeToNum(d.GradeYDS)); })
        .attr("opacity", '.5')
        .on('mouseover', function(d, i) {
        d3.select(this).transition()
            .duration('50')
            .attr("opacity", '1')
        div.transition()
            .duration(50)
            .style("opacity", 1);
        div.html(d.Ascensionist + "\n" + d.GradeYDS + "/" + d.GradeF + ", " + d.Year)
            .style("left", (d3.event.pageX + 10) + "px")
            .style("top", (d3.event.pageY - 15) + "px");
        })
        .on('mouseout', function(d,i) {
        d3.select(this).transition()
            .duration('50')
            .attr("opacity", '.5')
        div.transition()
            .duration('50')
            .style("opacity", 0);
    });

    // Appends x-axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x)
            .tickFormat(d3.format("d"))
            .ticks(30));

    // text label for the x axis
    svg.append("text")             
        .attr("transform",
                "translate(" + (width/2) + " ," + 
                            (height + margin.top + 10) + ")")
        .style("text-anchor", "middle")
        .text("Year");

    // Title (with custom font!)
    svg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "end")
    .attr("x", width/1.6)
    .attr("y", height -520)
    .style("font-size", "32px")
    .text("First Ascents")
    .attr("font-family", function(d,i) {return i<5 ? "Arvo" : "Sancreek"; })

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(y)
            .ticks(6, ".2f"));

    // text label for the y axis
    svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Grade (YDS)");  

    function gradeToNum(grade) {
        ltrGrade = grade.substring(4, 5)
        switch(ltrGrade) {
            case 'a':
                ltrGrade = 0
                break;
            case 'b':
                ltrGrade = .0025
                break;
            case 'c':
                ltrGrade = .005
                break;
            case 'd':
                ltrGrade = .0075
                break;
        }
        return +grade.substring(0, 4) + ltrGrade
    }

    function getColor(s) {
        if (s == "male") {
            return "steelblue"
        }
        else return "hotpink";
    }

    function getYear(y) {
        if(y == 1961) {
            return 1960
        }
        if(y == 2017) {
            return 2018
        }
        else return y;
    }

    function scaledGradeToNum(g) {
        grade = gradeToNum(g)
        if (grade == 5.12) {
            return 5.117
        }
        if(grade >= 5.155) {
            return 5.16
        }
        return grade
    }

});
</script>